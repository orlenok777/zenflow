<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="ZenFlow ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è, –æ—Å–∞–Ω–∫–∏, –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏ –∏ —Ñ–æ–∫—É—Å–∞">
    <meta name="theme-color" content="#34d399">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZenFlow">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#064e3b">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./icons/favicon.svg">
    <link rel="apple-touch-icon" href="./icons/icon-192.svg">
    <title>ZenFlow Ultimate: Connected Edition üß†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Marcellus&family=Quicksand:wght@300;400;500;600;700&display=swap');
        :root {
            --zen-green: #34d399;
            --zen-dark: #064e3b;
            --zen-light: #ecfdf5;
            --bg-grad-start: #f0fdf4;
            --bg-grad-end: #e0f2fe;
            --card-bg: rgba(255, 255, 255, 0.65);
            --text-main: #1c1917;
        }
        /* Night Mode Variables */
        body.night-mode {
            --bg-grad-start: #0f172a;
            --bg-grad-end: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #e2e8f0;
            color: #e2e8f0;
        }
        body.night-mode .glass-card {
            border-color: rgba(255, 255, 255, 0.1);
        }
        body.night-mode h1,
        body.night-mode h2,
        body.night-mode h3 {
            color: #34d399;
        }
        body.night-mode .metric-card {
            background: rgba(15, 23, 42, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }
        body.night-mode .metric-value {
            color: #34d399;
        }
        body.night-mode .settings-modal {
            background: rgba(15, 23, 42, 0.95);
            color: #e2e8f0;
        }
        body.night-mode .stat-value {
            color: #34d399;
        }
        body.night-mode .history-item {
            border-bottom-color: rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
        }
        body.night-mode input,
        body.night-mode select {
            background: #1e293b;
            color: white;
            border-color: #334155;
        }
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(-45deg, var(--bg-grad-start), var(--bg-grad-end), var(--bg-grad-start));
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: var(--text-main);
            overflow-x: hidden;
            transition: all 1.5s ease;
            touch-action: manipulation;
        }
        /* VR / HUD Mode Styles */
        body.vr-active {
            overflow: hidden;
            background: #000;
        }
        body.vr-active nav,
        body.vr-active .glass-card:not(#video-container-card),
        body.vr-active #main-grid>div:not(.video-column) {
            display: none !important;
        }
        body.vr-active #main-grid {
            display: block;
            width: 100%;
            height: 100vh;
            margin: 0;
            padding: 0;
        }
        body.vr-active .video-column {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
        }
        body.vr-active #video-wrapper {
            width: 100%;
            height: 100vh;
            border: none;
            border-radius: 0;
            background: #000;
        }
        body.vr-active video,
        body.vr-active canvas {
            object-fit: contain;
        }
        body.vr-active #vr-hud-stats {
            display: flex;
        }
        #vr-hud-stats {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            gap: 20px;
            align-items: center;
        }
        /* Privacy Blur Effect */
        body.privacy-blur #main-grid {
            filter: blur(15px);
            pointer-events: none;
        }
        #privacy-overlay {
            position: fixed;
            inset: 0;
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.4);
        }
        body.privacy-blur #privacy-overlay {
            display: flex;
        }
        /* Zen Mode Style */
        body.zen-active {
            filter: grayscale(0.8) contrast(1.1);
        }
        body.zen-active .glass-card,
        body.zen-active nav {
            opacity: 0.2;
            pointer-events: none;
            transition: opacity 1s;
        }
        body.zen-active #video-wrapper {
            transform: scale(1.05);
            box-shadow: 0 0 100px rgba(52, 211, 153, 0.5);
            border-color: #fff;
        }
        body.zen-active #zen-overlay-msg {
            opacity: 1;
        }
        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        h1,
        h2,
        h3,
        .zen-title {
            font-family: 'Marcellus', serif;
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
            border-radius: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 1s;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }
        .clickable-card {
            cursor: pointer;
        }
        .clickable-card:active {
            transform: scale(0.98);
        }
        .video-wrapper {
            position: relative;
            border-radius: 32px;
            width: 100%;
            aspect-ratio: 4/3;
            overflow: hidden;
            border: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            background: #000;
            transition: all 1s ease;
        }
        .shutter-flash {
            animation: flash-white 0.5s ease-out;
        }
        @keyframes flash-white {
            0% {
                filter: brightness(1);
            }
            10% {
                filter: brightness(4);
                outline: 10px solid white;
            }
            100% {
                filter: brightness(1);
            }
        }
        video,
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #output_canvas {
            pointer-events: none;
            z-index: 10;
        }
        #touch-overlay {
            position: absolute;
            inset: 0;
            background: rgba(16, 185, 129, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        #touch-overlay.active {
            opacity: 1;
        }
        #zen-overlay-msg {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 1s ease;
            color: #064e3b;
            text-shadow: 0 2px 10px rgba(255, 255, 255, 0.8);
        }
        /* Sport/Exercise Mode Overlay */
        #sport-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 45;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.5s ease;
        }
        #sport-overlay.active {
            display: flex;
        }
        .medal-pop {
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .tree-stage {
            font-size: 5rem;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, 0.1));
        }
        .btn-primary {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border-radius: 16px;
            padding: 10px 20px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .dot-online {
            background: #10b981;
            box-shadow: 0 0 6px #10b981;
        }
        .dot-offline {
            background: #9ca3af;
        }
        .dot-error {
            background: #ef4444;
        }
        .chat-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.85rem;
            margin-bottom: 8px;
            line-height: 1.4;
            color: #1c1917;
        }
        .chat-ai {
            background: #fff;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }
        .chat-user {
            background: #d1fae5;
            border-bottom-right-radius: 4px;
            align-self: flex-end;
        }
        .metric-card {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: background 0.2s;
            cursor: pointer;
        }
        .metric-card:hover {
            background: rgba(255, 255, 255, 0.8);
        }
        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #064e3b;
        }
        .metric-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280;
            margin-top: 4px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .breath-guide {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.8);
            animation: breathe 8s infinite ease-in-out;
            pointer-events: none;
            z-index: 15;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
        }
        @keyframes breathe {
            0%,
            100% {
                transform: scale(1);
                opacity: 0.5;
                content: "IN";
            }
            50% {
                transform: scale(2.5);
                opacity: 0.2;
                content: "OUT";
            }
        }
        #audioUnlockBtn {
            transition: all 0.3s ease;
        }
        #audioUnlockBtn.unlocked {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #34d399;
        }
        /* Settings & Stats Modal */
        #settings-modal,
        #stats-modal,
        #diagnostics-modal,
        #auto-report-alert {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
        }
        #settings-modal.active,
        #stats-modal.active,
        #diagnostics-modal.active,
        #auto-report-alert.active {
            display: flex;
        }
        .settings-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }
        .stat-content {
            background: white;
            border-radius: 24px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
        }
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .toggle-switch.active {
            background: #34d399;
        }
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        .stat-box {
            background: #f8fafc;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        body.night-mode .stat-box {
            background: rgba(30, 41, 59, 0.5);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .stat-big-val {
            font-size: 2rem;
            font-weight: 800;
            color: #059669;
            line-height: 1;
        }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #64748b;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }
        .history-list {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }
        /* Hydration Visuals CSS */
        .water-visuals {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: flex-end;
            gap: 15px;
            z-index: 40;
            pointer-events: none;
        }
        .bottle-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bottle-cap {
            width: 14px;
            height: 8px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 2px 2px 0 0;
        }
        .bottle-body {
            width: 36px;
            height: 100px;
            border: 2px solid rgba(255, 255, 255, 0.9);
            border-radius: 4px 4px 10px 10px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.9;
        }
        .water-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            transform: scaleX(0.8);
        }
        .glasses-row {
            display: flex;
            flex-wrap: wrap-reverse;
            gap: 4px;
            width: 80px;
            align-content: flex-end;
        }
        .glass-icon {
            font-size: 18px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from {
                transform: scale(0) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
        /* Debug Panel */
        #hydro-debug {
            position: absolute;
            right: 20px;
            top: 80px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-family: monospace;
            font-size: 10px;
            backdrop-filter: blur(4px);
            z-index: 35;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .debug-val {
            font-weight: bold;
            color: #34d399;
        }
        @media (max-width: 640px) {
            .video-wrapper {
                aspect-ratio: 3/4;
                border-radius: 20px;
                border-width: 2px;
            }
            .metric-card {
                padding: 8px;
            }
            .metric-value {
                font-size: 1rem;
            }
            h1 {
                font-size: 1rem;
            }
            .btn-primary {
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }
        /* Fix: no-scrollbar class for webkit browsers */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* Fix: animate-fade-in animation */
        @keyframes fadeInAnim {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in { animation: fadeInAnim 0.3s ease; }
    </style>
</head>
<body class="p-2 sm:p-4 flex flex-col items-center min-h-screen">
    <div id="vr-hud-stats">
        <div class="flex items-center gap-2">
            <span class="text-xl">‚è±Ô∏è</span>
            <span id="vr-timer" class="font-mono font-bold text-lg">00:00</span>
        </div>
        <div class="w-px h-6 bg-white/30"></div>
        <div class="flex items-center gap-2">
            <span class="text-xl">üíß</span>
            <span id="vr-water" class="font-bold text-lg text-blue-300">0</span>
        </div>
        <div class="w-px h-6 bg-white/30"></div>
        <div class="flex items-center gap-2">
            <span id="vr-vibe" class="text-2xl">üòê</span>
        </div>
        <button onclick="toggleVRMode()" class="bg-white/20 p-2 rounded-full hover:bg-white/40 transition">Exit</button>
    </div>
    <div id="privacy-overlay">
        <div class="bg-white/90 p-8 rounded-3xl text-center shadow-2xl">
            <div class="text-6xl mb-4">üõ°Ô∏è</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –†–µ–∂–∏–º</h2>
            <p class="text-gray-600">–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π.<br>–≠–∫—Ä–∞–Ω —Å–∫—Ä—ã—Ç.</p>
        </div>
    </div>
    <div id="zen-overlay-msg">
        <div class="text-6xl mb-4">üßò</div>
        <h2 class="text-4xl font-serif text-emerald-900 mb-2">–†–µ–∂–∏–º –î–∑–µ–Ω</h2>
        <p class="text-xl text-emerald-700">–î—ã—à–∏—Ç–µ. –°–ª—É—à–∞–π—Ç–µ. –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–π—Ç–µ.</p>
    </div>
    <!-- Auto Report Alert Modal (Hidden now for direct sending) -->
    <div id="auto-report-alert">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm mx-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-emerald-500"></div>
            <div class="text-4xl mb-2">üì§</div>
            <h3 class="text-lg font-bold text-gray-800 mb-1">–ê–≤—Ç–æ-–û—Ç—á–µ—Ç –ì–æ—Ç–æ–≤</h3>
            <p class="text-sm text-gray-600 mb-4">–í—Ä–µ–º—è –ø—Ä–∏—à–ª–æ. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?</p>
            <div class="flex gap-2">
                <button onclick="document.getElementById('auto-report-alert').classList.remove('active')"
                    class="flex-1 py-2 rounded-lg bg-gray-100 text-gray-600 font-bold text-xs hover:bg-gray-200">–ü–æ–∑–∂–µ</button>
                <button onclick="confirmAutoSend()"
                    class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold text-xs hover:bg-blue-700 shadow-lg shadow-blue-200">üöÄ
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    <div id="settings-modal">
        <div class="settings-content settings-modal">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold font-serif">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§—É–Ω–∫—Ü–∏–π</h3>
                <button id="closeSettings" class="text-2xl opacity-50 hover:opacity-100 p-2">&times;</button>
            </div>
            <!-- Auto Report Settings (NEW) -->
            <div class="mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100">
                <h4 class="text-xs font-bold uppercase tracking-widest text-blue-800 mb-3">‚è±Ô∏è –ê–≤—Ç–æ-–û—Ç—á–µ—Ç</h4>
                <div class="flex items-center justify-between mb-3 bg-white/50 p-2 rounded-lg">
                    <span class="text-sm font-bold text-stone-600">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–π–º–µ—Ä</span>
                    <div class="toggle-switch" id="toggle-auto-report"></div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-stone-500 uppercase">–ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                    <select id="cfg-report-interval"
                        class="w-full text-sm p-2 rounded-lg border border-stone-200 focus:outline-none focus:border-blue-400 font-bold text-stone-700">
                        <option value="1">–ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É (–¢–µ—Å—Ç)</option>
                        <option value="10">–ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç</option>
                        <option value="30">–ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç</option>
                        <option value="60">–ö–∞–∂–¥—ã–π —á–∞—Å</option>
                        <option value="180">–ö–∞–∂–¥—ã–µ 3 —á–∞—Å–∞</option>
                        <option value="day">–í –∫–æ–Ω—Ü–µ –¥–Ω—è (20:00)</option>
                    </select>
                    <!-- Verification Status -->
                    <div id="ar-last-run" class="text-[9px] text-stone-400 mt-1 text-right italic font-mono">
                        –¢–∞–π–º–µ—Ä: –û–∂–∏–¥–∞–Ω–∏–µ...
                    </div>
                </div>
            </div>
            <!-- Communication Module -->
            <div class="mb-6 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <h4 class="text-xs font-bold uppercase tracking-widest text-indigo-800 mb-3">üì° –ú–æ–¥—É–ª—å –°–≤—è–∑–∏</h4>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-stone-500 uppercase">WhatsApp (–ù–æ–º–µ—Ä)</label>
                        <input type="text" id="cfg-whatsapp" placeholder="79991234567"
                            class="w-full text-sm p-2 rounded-lg border border-stone-200 focus:outline-none focus:border-indigo-400 font-mono">
                    </div>
                </div>
            </div>
            <div id="settings-list" class="space-y-1">
                <!-- Toggles injected by JS -->
            </div>
        </div>
    </div>
    <div id="diagnostics-modal">
        <div class="settings-content settings-modal">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold font-serif text-red-800">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>
                <button id="closeDiagnostics" class="text-2xl opacity-50 hover:opacity-100 p-2">&times;</button>
            </div>
            <div class="space-y-2 text-xs font-mono">
                <div class="flex justify-between border-b pb-1"><span>FPS:</span> <span id="diag-fps"
                        class="font-bold">0</span></div>
                <div class="flex justify-between border-b pb-1"><span>–ö–∞–º–µ—Ä–∞:</span> <span id="diag-cam"
                        class="text-orange-500">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></div>
                <div class="flex justify-between border-b pb-1"><span>AI –õ–∏—Ü–æ:</span> <span id="diag-face">--</span>
                </div>
                <div class="flex justify-between border-b pb-1"><span>AI –†—É–∫–∏:</span> <span id="diag-hand">--</span>
                </div>
                <div class="flex justify-between border-b pb-1"><span>AI –û–±—ä–µ–∫—Ç—ã:</span> <span id="diag-obj">--</span>
                </div>
                <div class="flex justify-between border-b pb-1"><span>–ê—É–¥–∏–æ:</span> <span id="diag-audio">--</span>
                </div>
            </div>
            <div id="diag-log"
                class="mt-4 h-32 overflow-y-auto bg-gray-100 p-2 rounded border border-gray-300 text-[10px] font-mono leading-tight">
                <div class="text-gray-500 italic">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
            <button id="copyLogBtn"
                class="mt-2 w-full btn-primary text-xs py-3 bg-gray-200 text-gray-800 hover:bg-gray-300 shadow-none border border-gray-300 touch-manipulation">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                –ª–æ–≥</button>
        </div>
    </div>
    <div id="stats-modal">
        <div class="stat-content">
            <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-4">
                <div>
                    <h3 class="text-2xl font-bold font-serif text-emerald-900">–û—Ç—á–µ—Ç –æ –°–µ—Å—Å–∏–∏</h3>
                    <p class="text-[10px] uppercase tracking-widest text-stone-500">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</p>
                </div>
                <button id="closeStats"
                    class="text-2xl opacity-50 hover:opacity-100 w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors p-2">&times;</button>
            </div>
            <div class="bg-emerald-50 rounded-xl p-4 flex justify-between items-center mb-4 border border-emerald-100">
                <div class="flex items-center gap-3">
                    <span id="focus-icon" class="text-2xl">‚è±Ô∏è</span>
                    <div>
                        <span class="text-sm font-bold text-emerald-800 block">–í—Ä–µ–º—è –≤ —Ñ–æ–∫—É—Å–µ</span>
                        <span id="focus-status-text"
                            class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">–ê–∫—Ç–∏–≤–Ω–æ</span>
                    </div>
                </div>
                <span id="modal-timer" class="text-xl font-mono font-bold text-emerald-700">00:00:00</span>
            </div>
            <div class="bg-yellow-50 rounded-xl p-4 flex justify-between items-center mb-4 border border-yellow-100">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üí°</span>
                    <span class="text-sm font-bold text-yellow-800">–û—Å–≤–µ—â–µ–Ω–∏–µ</span>
                </div>
                <span id="modal-light-status" class="text-sm font-bold text-yellow-700">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div class="bg-blue-50 rounded-xl p-6 mb-4 border border-blue-100 text-center relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-8xl opacity-10">üíß</div>
                <h4 class="text-xs font-bold uppercase tracking-widest text-blue-800 mb-2">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏</h4>
                <div class="flex justify-center items-end gap-2">
                    <span id="modal-water-count" class="text-5xl font-black text-blue-600">0</span>
                    <span class="text-sm font-bold text-blue-400 mb-2">—Ä–∞–∑(–∞)</span>
                </div>
                <div class="mt-2 text-sm font-semibold text-blue-800">
                    ‚âà <span id="modal-water-vol">0</span> –ª–∏—Ç—Ä–æ–≤
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-xs font-bold uppercase mb-1">
                    <span class="text-stone-500">–ò–Ω–¥–µ–∫—Å –î–∑–µ–Ω–∞</span>
                    <span id="modal-zen-score" class="text-purple-600">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="modal-zen-bar" class="bg-purple-500 h-2.5 rounded-full transition-all duration-1000"
                        style="width: 0%"></div>
                </div>
            </div>
            <div class="stat-grid">
                <div class="stat-box">
                    <div id="modal-smiles" class="stat-big-val">0</div>
                    <div class="stat-label">–£–ª—ã–±–æ–∫ üòä</div>
                </div>
                <div class="stat-box">
                    <div id="modal-stretches" class="stat-big-val">0</div>
                    <div class="stat-label">–†–∞–∑–º–∏–Ω–æ–∫ üßò</div>
                </div>
                <div class="stat-box">
                    <div id="modal-posture" class="stat-big-val text-rose-500">0</div>
                    <div class="stat-label">–°–±–æ–µ–≤ –æ—Å–∞–Ω–∫–∏ üö∂</div>
                </div>
                <div class="stat-box">
                    <div id="modal-bad-habits" class="stat-big-val text-amber-500">0</div>
                    <div class="stat-label">–°–∏–≥–∞—Ä–µ—Ç/–ï–¥—ã üö≠</div>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-xs font-bold uppercase tracking-widest text-stone-500 mb-2">–ò—Å—Ç–æ—Ä–∏—è –°–æ–±—ã—Ç–∏–π</h4>
                <div id="history-list" class="history-list">
                    <div class="text-center text-xs text-gray-400 py-2">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                </div>
            </div>
            <!-- Share Action -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <button id="shareReportBtn"
                    class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform">
                    <span>üì§</span> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –û—Ç—á–µ—Ç (WhatsApp)
                </button>
                <p class="text-[9px] text-center text-gray-400 mt-2">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WhatsApp (Web/Mobile)</p>
            </div>
        </div>
    </div>
    <nav class="w-full max-w-7xl flex justify-between items-center mb-4 px-2">
        <div class="flex items-center gap-3">
            <span class="text-3xl filter drop-shadow-sm">üå∏</span>
            <div>
                <h1 class="text-lg font-bold zen-title uppercase tracking-tighter leading-none">ZenFlow</h1>
                <p class="text-[9px] font-black uppercase tracking-[0.2em] opacity-70">Bio-Hacker Edition</p>
            </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-3">
            <button onclick="toggleVRMode()"
                class="p-2 rounded-full bg-indigo-50 hover:bg-indigo-100 transition-all text-indigo-700 border border-indigo-100"
                title="VR / HUD Mode">ü•Ω</button>
            <button id="diagBtn"
                class="p-2 rounded-full bg-red-50 hover:bg-red-100 transition-all text-red-700 border border-red-100"
                title="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞">üêû</button>
            <button id="statsBtn" class="p-2 rounded-full bg-white/50 hover:bg-white/80 transition-all text-emerald-700"
                title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞">üìä</button>
            <button id="settingsBtn" class="p-2 rounded-full bg-white/50 hover:bg-white/80 transition-all"
                title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
            <button id="audioUnlockBtn"
                class="flex items-center gap-2 px-3 py-2 sm:py-1.5 rounded-full bg-rose-50 text-rose-700 text-[10px] sm:text-[9px] font-bold border border-rose-200 shadow-sm hover:shadow-md transition-all touch-manipulation">
                <span id="audioStatusIcon">üîá</span>
                <span id="audioStatusText" class="hidden sm:inline">–í–ö–õ –ó–í–£–ö</span>
            </button>
            <div
                class="hidden md:flex gap-1.5 bg-white/40 px-3 py-1.5 rounded-full backdrop-blur-sm border border-white/50">
                <span title="Face">
                    <div id="ind-face" class="status-dot dot-offline"></div>
                </span>
                <span title="Hands">
                    <div id="ind-hand" class="status-dot dot-offline"></div>
                </span>
                <span title="Objects">
                    <div id="ind-obj" class="status-dot dot-offline"></div>
                </span>
            </div>
            <div id="status-text"
                class="text-[9px] font-bold text-emerald-800 uppercase bg-white/60 px-3 py-1 rounded-full shadow-sm hidden sm:block">
                –ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </nav>
    <div id="main-grid" class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-6 transition-all duration-500">
        <div class="lg:col-span-3 space-y-4 order-2 lg:order-1">
            <div class="glass-card p-5 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-3 opacity-10 text-6xl rotate-12">üåø</div>
                <h2 class="text-xs font-bold uppercase tracking-widest mb-4 border-b border-emerald-100 pb-2">–°–∞–¥
                    –û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏</h2>
                <div class="flex items-center justify-between mb-2">
                    <div class="tree-stage" id="tree-display">üå±</div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-emerald-600 leading-none" id="tree-lvl">1</div>
                        <div class="text-[9px] uppercase font-bold text-stone-400">–£—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <div class="metric-card" onclick="announceStatus('water')">
                        <span id="water-count" class="metric-value">0</span>
                        <span class="metric-label">–ì–ª–æ—Ç–∫–∏</span>
                    </div>
                    <div class="metric-card" onclick="announceStatus('smile')">
                        <span id="smile-count" class="metric-value">0</span>
                        <span class="metric-label">–£–ª—ã–±–∫–∏</span>
                    </div>
                    <div class="metric-card" onclick="announceStatus('stretch')">
                        <span id="stretch-count" class="metric-value">0</span>
                        <span class="metric-label">–†–∞–∑–º–∏–Ω–∫–∞</span>
                    </div>
                    <div class="metric-card" onclick="announceStatus('yoga')">
                        <span id="yoga-count" class="metric-value">0</span>
                        <span class="metric-label">–§–µ–π—Å-–ô–æ–≥–∞</span>
                    </div>
                </div>
            </div>
            <div class="glass-card p-5">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-4 opacity-70">–ë–∏–æ–º–µ—Ç—Ä–∏—è</h3>
                <div class="space-y-4">
                    <div class="clickable-card" onclick="announceStatus('posture')">
                        <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                            <span class="opacity-70">–û—Å–∞–Ω–∫–∞</span>
                            <span id="posture-text" class="text-emerald-600">OK</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="posture-bar" class="progress-bar-fill bg-emerald-500" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="clickable-card" onclick="announceStatus('distance')">
                        <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                            <span class="opacity-70">–î–∏—Å—Ç–∞–Ω—Ü–∏—è</span>
                            <span id="dist-text" class="text-blue-600">--</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div id="dist-bar" class="progress-bar-fill bg-blue-500" style="width: 50%"></div>
                        </div>
                    </div>
                    <div class="clickable-card" onclick="announceStatus('tilt')">
                        <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                            <span class="opacity-70">–ù–∞–∫–ª–æ–Ω –ì–æ–ª–æ–≤—ã</span>
                            <span id="tilt-text" class="text-indigo-600">0¬∞</span>
                        </div>
                        <div class="progress-bar-bg flex justify-center bg-gray-200">
                            <div id="tilt-bar" class="h-full bg-indigo-500 transition-all duration-300 w-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-6 space-y-4 order-1 lg:order-2 video-column">
            <div id="video-wrapper" class="video-wrapper relative group">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="output_canvas"></canvas>
                <!-- Sport Mode Overlay -->
                <div id="sport-overlay">
                    <div class="text-6xl mb-4 animate-bounce">üèÉ</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2 font-serif">–°–ø–æ—Ä—Ç –¢–∞–π–º–µ—Ä</h2>
                    <div id="sport-timer" class="text-5xl font-mono font-bold text-emerald-600 mb-4">00:00</div>
                    <p class="text-sm text-gray-500 animate-pulse">–î–≤–∏–≥–∞–π—Ç–µ—Å—å! –Ø —Å–ª–µ–∂—É –∑–∞ –≤–∞–º–∏.</p>
                </div>
                <div id="live-ui"
                    class="absolute top-5 left-5 z-40 hidden flex-col gap-1 pointer-events-none select-none transition-opacity duration-1000">
                    <div class="flex items-center gap-2">
                        <div
                            class="bg-red-600/90 text-white text-[10px] font-bold px-2 py-0.5 rounded-md shadow-lg flex items-center gap-2 animate-pulse">
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                            –ü–†–Ø–ú–û–ô –≠–§–ò–†
                        </div>
                        <div
                            class="bg-black/40 backdrop-blur-md text-white text-[10px] font-mono px-2 py-0.5 rounded-md border border-white/10 shadow-lg">
                            <span id="live-timer">00:00:00</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-1 ml-1 opacity-80 mt-1">
                        <span class="text-[9px] text-white font-bold text-shadow">üëÅÔ∏è</span>
                        <span class="text-[9px] text-white font-mono font-bold text-shadow">1</span>
                    </div>
                    <div id="auto-pause-badge"
                        class="hidden mt-2 bg-yellow-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded-md shadow-lg animate-pulse">
                        ‚è∏Ô∏è –ê–í–¢–û-–ü–ê–£–ó–ê
                    </div>
                </div>
                <div id="hydro-debug">
                    <div class="text-[9px] uppercase font-bold text-gray-400 mb-1">–°—Ç–∞—Ç—É—Å –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏</div>
                    <div class="debug-row"><span>–û–±—ä–µ–∫—Ç:</span> <span id="dbg-obj" class="debug-val">--</span></div>
                    <div class="debug-row"><span>–°—Ç–∞—Ç—É—Å:</span> <span id="dbg-status"
                            class="debug-val text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ</span></div>
                    <div class="debug-row"><span>–†–æ—Ç:</span> <span id="dbg-mouth" class="debug-val">--</span></div>
                </div>
                <div class="water-visuals" id="hydration-overlay">
                    <div class="bottle-wrapper">
                        <div class="bottle-cap"></div>
                        <div class="bottle-body">
                            <div class="water-fill" id="bottle-water-level" style="height: 100%;"></div>
                        </div>
                    </div>
                    <div class="glasses-row" id="glasses-container"></div>
                </div>
                <div id="touch-overlay">
                    <div
                        class="bg-white/95 px-6 py-3 rounded-2xl shadow-xl border-2 border-emerald-400 backdrop-blur-md transform scale-110">
                        <span id="overlay-msg"
                            class="text-xl font-bold text-emerald-700 uppercase tracking-tighter">–û—Ç–ª–∏—á–Ω–æ!</span>
                    </div>
                </div>
                <div class="breath-guide"></div>
                <div id="pre-loader"
                    class="absolute inset-0 bg-emerald-50 flex flex-col items-center justify-center z-30 transition-opacity duration-700">
                    <div
                        class="w-10 h-10 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin mb-3">
                    </div>
                    <p class="text-emerald-800 text-[10px] font-bold uppercase tracking-widest animate-pulse">–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
                        –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π</p>
                </div>
                <div id="smart-alert"
                    class="absolute top-4 left-0 right-0 flex justify-center opacity-0 transition-opacity duration-300">
                    <div
                        class="bg-rose-500/90 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg flex items-center gap-2">
                        <span class="animate-bounce">‚ö†Ô∏è</span> <span id="alert-msg">–í–Ω–∏–º–∞–Ω–∏–µ</span>
                    </div>
                </div>
                <div id="ai-analyzing-overlay"
                    class="absolute inset-0 flex items-center justify-center pointer-events-none hidden bg-black/10 z-20">
                    <div
                        class="bg-white/90 backdrop-blur-md px-6 py-3 rounded-full flex items-center gap-3 shadow-xl border border-purple-200 animate-pulse">
                        <span class="text-2xl animate-bounce">üß†</span>
                        <span class="text-purple-900 font-bold uppercase tracking-widest text-xs">–ê–Ω–∞–ª–∏–∑
                            –æ–±—ä–µ–∫—Ç–∞...</span>
                    </div>
                </div>
            </div>
            <div class="flex justify-center">
                <button id="startBtn"
                    class="btn-primary opacity-50 text-sm tracking-widest uppercase touch-manipulation"
                    disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å ZenFlow</button>
            </div>
            <div class="glass-card px-4 py-3 flex justify-between items-center clickable-card">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 text-lg">
                        ü•±</div>
                    <div>
                        <div class="text-[9px] font-bold opacity-60 uppercase tracking-widest">–£—Å—Ç–∞–ª–æ—Å—Ç—å</div>
                        <div id="yawn-status" class="text-sm font-bold text-indigo-600">–ë–æ–¥—Ä</div>
                    </div>
                </div>
                <div class="h-8 w-px bg-stone-200"></div>
                <div class="flex items-center gap-3" onclick="announceStatus('zen')">
                    <div
                        class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-600 text-lg">
                        üôè</div>
                    <div>
                        <div class="text-[9px] font-bold opacity-60 uppercase tracking-widest">–î–∑–µ–Ω</div>
                        <div id="zen-status" class="text-sm font-bold text-teal-600">–°–ª–æ–∂–∏ —Ä—É–∫–∏</div>
                    </div>
                </div>
            </div>
            <div
                class="flex justify-center items-center gap-4 text-[10px] opacity-60 font-bold uppercase tracking-widest flex-wrap mt-2">
                <span title="–¢–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–π—á–∞—Å">–ú–æ–π –í–∞–π–±: <span id="vibe-emoji" class="text-lg">üòê</span></span>
                <span class="w-px h-3 bg-gray-400"></span>
                <span title="–°–≤–µ—Ç –≤ –∫–æ–º–Ω–∞—Ç–µ">–°–≤–µ—Ç: <span id="light-val">--</span></span>
            </div>
            <div class="glass-card p-4 mt-2">
                <h3 class="text-[9px] font-black opacity-50 uppercase tracking-[0.2em] mb-2">–§–æ—Ç–æ—Ö—Ä–æ–Ω–∏–∫–∞</h3>
                <div id="snapshot-gallery" class="flex gap-3 overflow-x-auto pb-2 scroll-smooth no-scrollbar"
                    style="scrollbar-width: none;">
                    <div
                        class="flex-shrink-0 w-full text-center py-6 text-[10px] text-stone-400 italic bg-stone-50/50 rounded-xl border border-dashed border-stone-200">
                        –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–µ—á–∞—Ç–ª–µ–µ—Ç –≤–∞—à–∏ –ª—É—á—à–∏–µ –º–æ–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...
                    </div>
                </div>
            </div>
        </div>
        <div class="lg:col-span-3 order-3 lg:order-3">
            <div class="glass-card h-[600px] flex flex-col overflow-hidden">
                <div
                    class="p-4 border-b border-white/50 bg-white/30 flex justify-between items-center backdrop-blur-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse" id="ai-status-dot"></div>
                        <h3 class="text-[10px] font-bold uppercase tracking-widest text-emerald-900">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
                    </div>
                    <div id="voice-indicator" class="w-4 h-3 flex gap-0.5 items-end justify-center hidden">
                        <div class="w-1 bg-emerald-500 animate-bounce h-2"></div>
                        <div class="w-1 bg-emerald-500 animate-bounce h-3 delay-75"></div>
                        <div class="w-1 bg-emerald-500 animate-bounce h-1 delay-150"></div>
                    </div>
                </div>
                <div id="chat-box"
                    class="flex-grow p-4 overflow-y-auto flex flex-col gap-3 scroll-smooth text-sm bg-gradient-to-b from-transparent to-white/20">
                    <div class="chat-bubble chat-ai">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é. –ù–æ–≤—ã–µ –±–∏–æ-—Ö–∞–∫ –º–æ–¥—É–ª–∏:
                        <br>‚Ä¢ üèÉ <b>–†–µ–∂–∏–º –°–ø–æ—Ä—Ç–∞ (New)</b>
                        <br>‚Ä¢ ‚è±Ô∏è –ê–≤—Ç–æ-–û—Ç—á–µ—Ç
                        <br>‚Ä¢ üåó –°–≤–µ—Ç–æ–≤–æ–π –°—Ç—Ä–∞–∂
                        <br>‚Ä¢ ‚è∏Ô∏è –ê–≤—Ç–æ-–ü–∞—É–∑–∞ –§–æ–∫—É—Å–∞
                        <br>‚Ä¢ üé≠ –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ó–µ—Ä–∫–∞–ª–æ
                        <br>‚Ä¢ üì§ –ú–æ–¥—É–ª—å –°–≤—è–∑–∏ (WhatsApp)
                        <br>‚Ä¢ ü•Ω VR/HUD –†–µ–∂–∏–º
                    </div>
                </div>
                <div class="p-4 bg-white/60 backdrop-blur-md border-t border-white">
                    <button id="adviceBtn"
                        class="w-full py-3 bg-gradient-to-r from-emerald-100 to-teal-100 hover:from-emerald-200 hover:to-teal-200 text-emerald-900 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all shadow-sm border border-emerald-200/50 touch-manipulation">
                        ‚ú® –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ú—É–¥—Ä–æ—Å—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        // Suppress specific TensorFlow Lite info messages
        const originalConsoleError = console.error;
        console.error = function (...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('TensorFlow Lite XNNPACK')) return;
            originalConsoleError.apply(console, args);
        };
        import { FaceLandmarker, HandLandmarker, ObjectDetector, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";
        // --- Config & State ---
        const state = {
            water: 0, smiles: 0, stretches: 0, faceYoga: 0, treeLevel: 1,
            cigaretteCount: 0, foodCount: 0, postureCorrections: 0,
            cameraActive: false, lastActionTs: 0, frameCount: 0, audioUnlocked: false,
            lastMouthPos: null, lastMouthTs: 0, lastDetections: [], isProcessing: false,
            lowPowerMode: false, lowFPSCount: 0, history: [],
            bottleCapacity: 2000, currentWater: 2000,
            lastPostureWarn: 0, lastDistanceWarn: 0, lastLightWarn: 0, lastBlinkCheck: 0,
            lastYawnTs: 0, lastStretchTs: 0, lastPhoneWarn: 0, lastGestureTs: 0, lastYogaTs: 0, lastAiCheck: 0, lastFaceTouchWarn: 0,
            focusStartTime: 0, totalFocusTime: 0, lastFocusUpdate: 0, isTimerPaused: false, lastFaceSeenTs: 0,
            isFocused: true, isZenMode: false, isNightMode: false, isVRMode: false, isAnalyzing: false,
            blinks: 0, blinkHistory: [], avgLight: 0,
            currDist: 0, currPosture: "ok", currTilt: 0,
            // Sport Mode Variables
            sittingStartTime: Date.now(),
            isExercising: false,
            calibrationSamples: [], // For baseline averaging
            exerciseStartTime: 0,
            lastStandUpCheck: 0,
            baselineNoseY: null, // To store calibration data
            // Contacts & Settings
            contacts: {
                phone: (function() { try { return localStorage.getItem('zen_phone') || ''; } catch(e) { return ''; } })()
            },
            // Auto Report Settings
            autoReport: {
                enabled: (function() { try { return localStorage.getItem('zen_ar_enabled') === 'true'; } catch(e) { return false; } })(),
                interval: (function() { try { return parseInt(localStorage.getItem('zen_ar_interval')) || 60; } catch(e) { return 60; } })(), // minutes
                lastSent: Date.now()
            },
            features: {
                water: true, smile: true, stretch: true, posture: true, distance: true,
                yawn: true, phone: true, zen: true, nightMode: true, gestures: true,
                light: true, blink: true, privacy: true, faceYoga: true, heart: true,
                aiObjectCheck: true, worldLens: true, autoPause: true, faceTouch: true,
                sportMode: true // New Feature
            }
        };
        const FEATURE_NAMES = {
            water: "üíß –ì–∏–¥—Ä–∞—Ç–∞—Ü–∏—è", smile: "üòä –£–ª—ã–±–∫–∞", stretch: "üßò –†–∞–∑–º–∏–Ω–∫–∞ –®–µ–∏",
            posture: "üö∂ –û—Å–∞–Ω–∫–∞", distance: "üìè –î–∏—Å—Ç–∞–Ω—Ü–∏—è", yawn: "üò¥ –î–µ—Ç–µ–∫—Ç–æ—Ä –ó–µ–≤–æ—Ç—ã",
            phone: "üìµ –¶–∏—Ñ—Ä–æ–≤–æ–π –î–µ—Ç–æ–∫—Å", zen: "üôè –†–µ–∂–∏–º –î–∑–µ–Ω", nightMode: "üåô –ù–æ—á–Ω–æ–π –†–µ–∂–∏–º",
            gestures: "‚úåÔ∏è –ñ–µ—Å—Ç—ã –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è", light: "üí° –ê–Ω–∞–ª–∏–∑ –°–≤–µ—Ç–∞", blink: "üëÅÔ∏è –ú–æ—Ä–≥–∞–Ω–∏–µ",
            privacy: "üõ°Ô∏è –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –©–∏—Ç", faceYoga: "ü§® –§–µ–π—Å-–ô–æ–≥–∞", heart: "‚ù§Ô∏è –ñ–µ—Å—Ç –°–µ—Ä–¥—Ü–∞",
            aiObjectCheck: "ü§ñ AI –î–µ—Ç–µ–∫—Ç–æ—Ä –ü—Ä–∏–≤—ã—á–µ–∫", worldLens: "üëÅÔ∏è –õ–∏–Ω–∑–∞ –ú–∏—Ä–∞",
            autoPause: "‚è∏Ô∏è –ê–≤—Ç–æ-–ü–∞—É–∑–∞", faceTouch: "‚úã –ì–∏–≥–∏–µ–Ω–∞ –õ–∏—Ü–∞", sportMode: "üèÉ –†–µ–∂–∏–º –°–ø–æ—Ä—Ç–∞"
        };
        const TREES = ["üå±", "üåø", "ü™¥", "üéã", "üå≥", "üå≤", "üå∏", "üçé", "üëë"];
        const apiKey = ""; // Insert Gemini Key if needed
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const OBJECT_TRANSLATIONS = {
            "person": "–ß–µ–ª–æ–≤–µ–∫", "bottle": "–ë—É—Ç—ã–ª–∫–∞", "cup": "–ß–∞—à–∫–∞", "cell phone": "–¢–µ–ª–µ—Ñ–æ–Ω", "laptop": "–ù–æ—É—Ç–±—É–∫",
            "book": "–ö–Ω–∏–≥–∞", "chair": "–°—Ç—É–ª", "potted plant": "–†–∞—Å—Ç–µ–Ω–∏–µ"
        };
        const video = document.getElementById("webcam");
        const canvas = document.getElementById("output_canvas");
        const ctx = canvas.getContext("2d");
        let faceLM, handLM, objectDet, drawingUtils;
        let lastTime = -1;
        // --- Audio Context for Ticking Sound ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTickSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.05);
        }
        // --- Logger Utility ---
        function logDiag(msg) {
            const log = document.getElementById('diag-log');
            const time = new Date().toLocaleTimeString();
            const el = document.createElement('div');
            el.innerHTML = `<span class="text-gray-400">[${time}]</span> ${msg}`;
            log.prepend(el);
            if (log.children.length > 50) log.lastChild.remove();
        }
        // --- Contacts & Auto-Report Logic ---
        const phoneInput = document.getElementById('cfg-whatsapp');
        const arToggle = document.getElementById('toggle-auto-report');
        const arInterval = document.getElementById('cfg-report-interval');
        // Init Settings UI
        phoneInput.value = state.contacts.phone;
        if (state.autoReport.enabled) arToggle.classList.add('active');
        arInterval.value = state.autoReport.interval;
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.add('active');
        });
        function saveSettings() {
            state.contacts.phone = phoneInput.value.replace(/[^0-9]/g, '');
            state.autoReport.enabled = arToggle.classList.contains('active');
            const val = arInterval.value;
            state.autoReport.interval = val === 'day' ? 'day' : parseInt(val);
            // Wrap localStorage in try/catch for private browsing mode
            try {
                localStorage.setItem('zen_phone', state.contacts.phone);
                localStorage.setItem('zen_ar_enabled', state.autoReport.enabled);
                localStorage.setItem('zen_ar_interval', val);
            } catch(e) {
                console.warn("localStorage unavailable (private browsing?)");
            }
            // Reset timer on save
            state.autoReport.lastSent = Date.now();
        }
        phoneInput.addEventListener('input', saveSettings);
        arInterval.addEventListener('change', saveSettings);
        arToggle.addEventListener('click', () => {
            arToggle.classList.toggle('active');
            saveSettings();
        });
        // --- Check Auto Report Timer ---
        function checkAutoReport() {
            if (!state.autoReport.enabled) return;
            const now = Date.now();
            let shouldSend = false;
            // Visual Check - Update UI to show we are checking
            const statusEl = document.getElementById('ar-last-run');
            if (statusEl) {
                // Throttle UI update to avoid flicker, or just update every check
                // Since this runs every minute, it's fine.
                statusEl.innerText = `–ü—Ä–æ–≤–µ—Ä–∫–∞: ${new Date().toLocaleTimeString()}`;
            }
            if (state.autoReport.interval === 'day') {
                // Check if it's past 20:00 and we haven't sent it today
                const hour = new Date().getHours();
                const lastSentDate = new Date(state.autoReport.lastSent).getDate();
                const today = new Date().getDate();
                if (hour >= 20 && lastSentDate !== today) shouldSend = true;
            } else {
                // Time interval check
                const diff = now - state.autoReport.lastSent;
                const limit = state.autoReport.interval * 60 * 1000;
                if (diff > limit) shouldSend = true;
            }
            if (shouldSend) {
                // Direct Send without Confirmation Window
                state.autoReport.lastSent = now; // Reset immediately to prevent double triggers
                window.speakZen("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞.");
                // Add history event for verification
                addHistoryEvent('üöÄ', '–ê–≤—Ç–æ-–æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                // Directly call send function
                generateAndShareReport(true);
            }
        }
        // Exposed for HTML button
        window.confirmAutoSend = function () {
            document.getElementById('auto-report-alert').classList.remove('active');
            generateAndShareReport(true); // true = automated flag
        }
        // --- Sharing Logic ---
        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
            return new Blob([ab], { type: mimeString });
        }
        async function generateAndShareReport(isAuto = false) {
            const btn = document.getElementById('shareReportBtn');
            const originalText = btn.innerHTML;
            if (!isAuto) btn.innerHTML = `<span class="animate-spin">‚è≥</span> –°–æ–∑–¥–∞–Ω–∏–µ...`;
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            const typeStr = isAuto ? "AUTO-REPORT" : "MANUAL-REPORT";
            // Fix: Remove extra indentation from template literal to avoid leading spaces in report
            const reportText = `üß† ZenFlow ${typeStr} [${date} ${time}]

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚Ä¢ üíß –í–æ–¥–∞: ${state.water} (${(state.water * 0.2).toFixed(1)}–ª)
‚Ä¢ üòä –£–ª—ã–±–∫–∏: ${state.smiles}
‚Ä¢ üßò –†–∞–∑–º–∏–Ω–∫–∞: ${state.stretches}
‚Ä¢ üö∂ –û—Å–∞–Ω–∫–∞: ${state.postureCorrections} —Å–±–æ–µ–≤
‚Ä¢ üìµ –§–æ–∫—É—Å: ${document.getElementById('live-timer').innerText}
üèÜ –î–∑–µ–Ω –£—Ä–æ–≤–µ–Ω—å: ${state.treeLevel}
üåø –°–æ—Å—Ç–æ—è–Ω–∏–µ –°–∞–¥–∞: ${TREES[Math.min(state.treeLevel - 1, TREES.length - 1)]}
#ZenFlow #BioHacking`;
            const snapDataUrl = performSnapshot("audit");
            try {
                // Priority 1: Native Share (Mobile) - Works best on phones
                // Note: Native share typically requires a user gesture, so it might not open on auto-timer
                if (navigator.share && !isAuto) {
                    const blob = dataURItoBlob(snapDataUrl);
                    const file = new File([blob], `zenflow_report_${Date.now()}.jpg`, { type: "image/jpeg" });
                    await navigator.share({ title: 'ZenFlow Report', text: reportText, files: [file] });
                    logDiag("–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (Native)");
                } else {
                    // Fallback to WhatsApp link
                    if (state.contacts.phone) {
                        const url = `https://wa.me/${state.contacts.phone}?text=${encodeURIComponent(reportText)}`;
                        window.open(url, '_blank');
                    } else {
                        if (!isAuto) {
                            navigator.clipboard.writeText(reportText);
                            alert("–û—Ç—á–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä! (–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä WhatsApp –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)");
                        }
                    }
                    // Don't auto-download file in auto-mode to avoid spamming downloads
                    if (!isAuto) {
                        const link = document.createElement('a'); link.download = 'zen-report.jpg'; link.href = snapDataUrl; link.click();
                    }
                }
            } catch (err) {
                console.error(err);
            } finally {
                btn.innerHTML = originalText;
            }
        }
        document.getElementById('shareReportBtn').addEventListener('click', () => generateAndShareReport(false));
        // --- Standard UI Logic ---
        document.getElementById('diagBtn').onclick = () => document.getElementById('diagnostics-modal').classList.add('active');
        document.getElementById('closeDiagnostics').onclick = () => document.getElementById('diagnostics-modal').classList.remove('active');
        document.getElementById('copyLogBtn').onclick = () => { navigator.clipboard.writeText(document.getElementById('diag-log').innerText); alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"); };
        window.toggleVRMode = function () {
            state.isVRMode = !state.isVRMode;
            document.body.classList.toggle('vr-active', state.isVRMode);
        }
        // Fix: Add keyboard shortcuts for VR mode (V) and mute/unmute (M)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'v' || e.key === 'V') {
                e.preventDefault();
                toggleVRMode();
                window.speakZen(state.isVRMode ? "VR —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω." : "VR —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω.", true);
            }
            if (e.key === 'm' || e.key === 'M') {
                e.preventDefault();
                unlockAudio();
                window.speakZen(state.audioUnlocked ? "–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω." : "–ó–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω.", true);
            }
        });
        function renderSettings() {
            const list = document.getElementById('settings-list');
            list.innerHTML = '';
            const allEnabled = Object.values(state.features).every(v => v);
            const masterRow = document.createElement('div');
            masterRow.className = 'toggle-row mb-3 pb-3 border-b border-gray-200 bg-gray-50/50 px-2 rounded-lg';
            masterRow.innerHTML = `<span class="font-bold text-sm text-emerald-700 flex items-center gap-2">‚ö° ${allEnabled ? '–û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ' : '–í–∫–ª—é—á–∏—Ç—å –≤—Å–µ'}</span><div class="toggle-switch ${allEnabled ? 'active' : ''}"></div>`;
            masterRow.onclick = () => {
                const newState = !allEnabled;
                for (const key in state.features) state.features[key] = newState;
                if (!newState) { document.body.classList.remove('night-mode', 'privacy-blur'); if (state.isZenMode) toggleZenMode(false); }
                renderSettings();
            };
            list.appendChild(masterRow);
            for (const [key, enabled] of Object.entries(state.features)) {
                const row = document.createElement('div');
                row.className = 'toggle-row px-2 hover:bg-gray-50 rounded-lg transition-colors';
                row.innerHTML = `<span class="font-bold text-sm">${FEATURE_NAMES[key] || key}</span><div class="toggle-switch ${enabled ? 'active' : ''}" data-key="${key}"></div>`;
                row.querySelector('.toggle-switch').onclick = (e) => {
                    e.stopPropagation();
                    const k = e.currentTarget.dataset.key;
                    state.features[k] = !state.features[k];
                    if (k === 'nightMode' && !state.features[k]) document.body.classList.remove('night-mode');
                    if (k === 'privacy' && !state.features[k]) document.body.classList.remove('privacy-blur');
                    if (k === 'zen' && !state.features[k] && state.isZenMode) toggleZenMode(false);
                    renderSettings();
                };
                list.appendChild(row);
            }
        }
        document.getElementById('settingsBtn').onclick = () => { renderSettings(); document.getElementById('settings-modal').classList.add('active'); };
        document.getElementById('closeSettings').onclick = () => document.getElementById('settings-modal').classList.remove('active');
        function addHistoryEvent(icon, text) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            state.history.unshift({ time, icon, text });
            if (state.history.length > 20) state.history.pop();
            renderHistory();
        }
        function renderHistory() {
            const container = document.getElementById('history-list');
            if (state.history.length === 0) { container.innerHTML = '<div class="text-center text-xs text-gray-400 py-2">–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
            container.innerHTML = state.history.map(item => `<div class="history-item"><span class="font-mono text-gray-400">${item.time}</span><span class="font-bold text-gray-700 flex-1 ml-2">${item.icon} ${item.text}</span></div>`).join('');
        }
        function updateStatsUI() {
            document.getElementById('water-count').innerText = state.water;
            document.getElementById('smile-count').innerText = state.smiles;
            document.getElementById('stretch-count').innerText = state.stretches;
            document.getElementById('yoga-count').innerText = state.faceYoga;
            document.getElementById('modal-water-count').innerText = state.water;
            document.getElementById('modal-water-vol').innerText = (state.water * 0.2).toFixed(1);
            document.getElementById('modal-smiles').innerText = state.smiles;
            document.getElementById('modal-stretches').innerText = state.stretches + state.faceYoga;
            document.getElementById('modal-posture').innerText = state.postureCorrections;
            document.getElementById('modal-bad-habits').innerText = state.cigaretteCount + state.foodCount;
            document.getElementById('vr-water').innerText = state.water;
            let score = 50 + ((state.smiles + state.water + state.stretches + state.faceYoga) * 2) - ((state.postureCorrections + state.cigaretteCount) * 3);
            score = Math.max(0, Math.min(100, score));
            document.getElementById('modal-zen-score').innerText = Math.round(score) + "%";
            const bar = document.getElementById('modal-zen-bar');
            bar.style.width = score + "%";
            bar.className = score > 80 ? "bg-emerald-500 h-2.5 rounded-full transition-all duration-1000" : score > 50 ? "bg-yellow-500 h-2.5 rounded-full transition-all duration-1000" : "bg-rose-500 h-2.5 rounded-full transition-all duration-1000";
        }
        function updateLiveTimer() {
            if (!state.cameraActive) return;
            const now = Date.now();
            if (state.features.autoPause) {
                if (now - state.lastFaceSeenTs > 5000) {
                    if (!state.isTimerPaused) {
                        state.isTimerPaused = true;
                        document.getElementById('auto-pause-badge').classList.remove('hidden');
                        document.getElementById('focus-status-text').innerText = "–ü–ê–£–ó–ê";
                        document.getElementById('focus-status-text').className = "text-[10px] text-amber-500 font-bold uppercase tracking-wider";
                        document.getElementById('focus-icon').innerText = "‚è∏Ô∏è";
                        state.totalFocusTime += (state.lastFocusUpdate - state.focusStartTime);
                    }
                } else {
                    if (state.isTimerPaused) {
                        state.isTimerPaused = false;
                        document.getElementById('auto-pause-badge').classList.add('hidden');
                        document.getElementById('focus-status-text').innerText = "–ê–ö–¢–ò–í–ù–û";
                        document.getElementById('focus-status-text').className = "text-[10px] text-emerald-600 font-bold uppercase tracking-wider";
                        document.getElementById('focus-icon').innerText = "‚è±Ô∏è";
                        state.focusStartTime = now;
                    }
                }
            }
            let diff = state.isTimerPaused ? state.totalFocusTime : state.totalFocusTime + (now - state.focusStartTime);
            if (!state.isTimerPaused) state.lastFocusUpdate = now;
            const hrs = Math.floor(diff / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            const pad = (n) => n.toString().padStart(2, '0');
            const timeStr = `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
            document.getElementById('live-timer').innerText = timeStr;
            document.getElementById('modal-timer').innerText = timeStr;
            document.getElementById('vr-timer').innerText = `${pad(mins)}:${pad(secs)}`;
        }
        setInterval(updateLiveTimer, 1000);
        // --- Sport Mode Logic ---
        function updateSportTimer() {
            if (!state.isExercising) return;
            const now = Date.now();
            const elapsed = Math.floor((now - state.exerciseStartTime) / 1000);
            // Play ticking sound
            if (elapsed > 0 && elapsed % 1 === 0) playTickSound();
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            // Fix: Estimate calories burned (~5 cal/min of standing movement)
            const estimatedCalories = Math.round((elapsed / 60) * 5);
            const timerDisplay = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const caloriesDisplay = estimatedCalories > 0 ? ` (${estimatedCalories} kcal)` : '';
            document.getElementById('sport-timer').innerText = timerDisplay + caloriesDisplay;
        }
        setInterval(updateSportTimer, 1000);
        document.getElementById('statsBtn').onclick = () => { updateStatsUI(); renderHistory(); document.getElementById('stats-modal').classList.add('active'); };
        document.getElementById('closeStats').onclick = () => document.getElementById('stats-modal').classList.remove('active');
        function updateWaterVisuals() {
            state.currentWater -= 200;
            if (state.currentWater < 0) { state.currentWater = state.bottleCapacity; document.getElementById('glasses-container').innerHTML = ''; }
            const pct = (state.currentWater / state.bottleCapacity) * 100;
            document.getElementById('bottle-water-level').style.height = `${pct}%`;
            const glass = document.createElement('div'); glass.className = 'glass-icon'; glass.innerText = 'ü•§';
            document.getElementById('glasses-container').appendChild(glass);
        }
        function getDistance(p1, p2) { return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)); }
        window.speakZen = function (text, priority = false) {
            if (!window.speechSynthesis || (!state.audioUnlocked && !priority)) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ru-RU';
            utterance.pitch = state.isZenMode ? 0.7 : 0.9;
            utterance.rate = state.isZenMode ? 0.8 : 1.0;
            const indicator = document.getElementById('voice-indicator');
            utterance.onstart = () => { if (indicator) indicator.classList.remove('hidden'); };
            utterance.onend = () => { if (indicator) indicator.classList.add('hidden'); };
            window.speechSynthesis.speak(utterance);
        }
        function showAlert(msg, colorClass = "bg-rose-500") {
            const el = document.getElementById('smart-alert');
            const txt = document.getElementById('alert-msg');
            txt.innerText = msg;
            el.className = `absolute top-4 left-0 right-0 flex justify-center transition-opacity duration-300 opacity-100`;
            el.firstElementChild.className = `${colorClass}/90 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg flex items-center gap-2`;
            setTimeout(() => { el.classList.remove('opacity-100'); el.classList.add('opacity-0'); }, 3000);
        }
        function checkTimeTheme() {
            // Check auto report timer here
            checkAutoReport();
            // Check Sedentary Timer
            if (state.features.sportMode && !state.isExercising) {
                // For testing, warn after 20 minutes (1200000ms). Use 1 min (60000ms) for quick testing
                if (Date.now() - state.sittingStartTime > 1200000) {
                    state.sittingStartTime = Date.now(); // reset to nag later
                    window.speakZen("–í—Å—Ç–∞–Ω—å—Ç–µ –∏ –ø–æ–¥–≤–∏–≥–∞–π—Ç–µ—Å—å. –ó–∞—Å—Ç–æ–π –≤—Ä–µ–¥–µ–Ω.");
                    showAlert("üèÉ –í—Å—Ç–∞–Ω—å—Ç–µ –∏ –ø–æ–¥–≤–∏–≥–∞–π—Ç–µ—Å—å!", "bg-orange-500");
                }
            }
            if (!state.features.nightMode) return;
            const hour = new Date().getHours();
            if (hour >= 20 || hour < 7) {
                if (!state.isNightMode) { state.isNightMode = true; document.body.classList.add('night-mode'); addChat("–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω.", 'ai'); }
            } else {
                if (state.isNightMode) { state.isNightMode = false; document.body.classList.remove('night-mode'); }
            }
        }
        setInterval(checkTimeTheme, 60000);
        window.announceStatus = function (type) {
            if (!state.audioUnlocked) unlockAudio();
            let msg = "";
            switch (type) {
                case 'water': msg = `–í—ã —Å–¥–µ–ª–∞–ª–∏ ${state.water} –≥–ª–æ—Ç–∫–æ–≤.`; break;
                case 'smile': msg = `–í—ã —É–ª—ã–±–Ω—É–ª–∏—Å—å ${state.smiles} —Ä–∞–∑.`; break;
                case 'stretch': msg = `–†–∞–∑–º–∏–Ω–æ–∫ —à–µ–∏: ${state.stretches}.`; break;
                case 'yoga': msg = `–§–µ–π—Å-–π–æ–≥–∞: ${state.faceYoga}.`; break;
                case 'posture': msg = state.currPosture === "bad" ? "–í—ã–ø—Ä—è–º–∏—Ç–µ—Å—å." : "–û—Å–∞–Ω–∫–∞ —Ö–æ—Ä–æ—à–∞—è."; break;
                case 'distance': msg = state.currDist > 0.25 ? "–û—Ç–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å." : state.currDist < 0.10 ? "–ü–æ–¥–æ–π–¥–∏—Ç–µ –±–ª–∏–∂–µ." : "–ù–æ—Ä–º–∞."; break;
                case 'zen': msg = "–°–ª–æ–∂–∏—Ç–µ –ª–∞–¥–æ–Ω–∏ –≤–º–µ—Å—Ç–µ."; break;
                case 'tilt': msg = `–ù–∞–∫–ª–æ–Ω: ${Math.round(state.currTilt)} –≥—Ä–∞–¥—É—Å–æ–≤.`; break;
                case 'audit': msg = `–û—Ç—á–µ—Ç. –ì–ª–æ—Ç–∫–æ–≤: ${state.water}. –£–ª—ã–±–æ–∫: ${state.smiles}.`; break;
            }
            if (msg) window.speakZen(msg, true);
        }
        const audioBtn = document.getElementById('audioUnlockBtn');
        function unlockAudio() {
            if (state.audioUnlocked) return;
            try {
                const silent = new SpeechSynthesisUtterance("");
                window.speechSynthesis.speak(silent);
                state.audioUnlocked = true;
                audioBtn.classList.add('unlocked');
                document.getElementById('audioStatusIcon').innerText = "üîä";
                document.getElementById('audioStatusText').innerText = "–ó–í–£–ö –ï–°–¢–¨";
                // Fix: Update diag-audio element
                const diagAudio = document.getElementById('diag-audio');
                if (diagAudio) { diagAudio.innerText = "OK"; diagAudio.className = "text-green-600 font-bold"; }
                logDiag("–ê—É–¥–∏–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ");
            } catch (e) {
                document.getElementById('diag-audio').className = "text-red-600";
                logDiag("–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ");
            }
        }
        audioBtn.addEventListener('click', () => { unlockAudio(); window.speakZen("–°–∏—Å—Ç–µ–º—ã –≤–∫–ª—é—á–µ–Ω—ã.", true); });
        function performSnapshot(triggerType = "success") {
            const wrapper = document.getElementById('video-wrapper');
            const gallery = document.getElementById('snapshot-gallery');
            wrapper.classList.remove('shutter-flash');
            void wrapper.offsetWidth;
            wrapper.classList.add('shutter-flash');
            try {
                const snapCanvas = document.createElement('canvas');
                snapCanvas.width = video.videoWidth; snapCanvas.height = video.videoHeight;
                const sCtx = snapCanvas.getContext('2d');
                sCtx.translate(snapCanvas.width, 0); sCtx.scale(-1, 1);
                sCtx.drawImage(video, 0, 0);
                sCtx.font = "bold 60px sans-serif"; sCtx.fillStyle = "white"; sCtx.shadowColor = "black"; sCtx.shadowBlur = 10;
                let icon = "";
                if (triggerType === "smile") icon = "üòä"; else if (triggerType === "water") icon = "üíß";
                else if (triggerType === "stretch") icon = "üßò"; else if (triggerType === "zen") icon = "üôè";
                else if (triggerType === "energy") icon = "‚ö°"; else if (triggerType === "heart") icon = "‚ù§Ô∏è";
                if (icon) sCtx.fillText(icon, 30, 80);
                const dataUrl = snapCanvas.toDataURL('image/jpeg', 0.85);
                if (triggerType !== "audit" && triggerType !== "ai-check") {
                    if (gallery.innerText.includes('–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–µ—á–∞—Ç–ª–µ–µ—Ç')) gallery.innerHTML = '';
                    const div = document.createElement('div');
                    div.className = 'snapshot-item flex-shrink-0 w-[120px] h-[90px] rounded-xl overflow-hidden border-2 border-white shadow-sm relative cursor-pointer hover:scale-105 transition-transform';
                    div.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover"><div class="absolute bottom-0 w-full bg-black/40 text-white text-[8px] text-center py-1 backdrop-blur-sm">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
                    div.onclick = () => { const link = document.createElement('a'); link.download = `zen-${Date.now()}.jpg`; link.href = dataUrl; link.click(); };
                    gallery.prepend(div);
                    // Fix: Limit snapshots to 20 to prevent memory leak
                    while (gallery.children.length > 20) { gallery.lastChild.remove(); }
                }
                return dataUrl;
            } catch (e) { console.error("Snap error", e); return null; }
        }
        async function analyzeObjectWithGemini(base64Image) {
            if (state.isAnalyzing) return;
            state.isAnalyzing = true;
            document.getElementById('ai-analyzing-overlay').classList.remove('hidden');
            try {
                // Fix: Check if API key is configured
                if (!apiKey || apiKey.trim() === '') {
                    const msg = "AI –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
                    addChat(`ü§ñ AI: ${msg}`, 'ai');
                    throw new Error("API key not configured");
                }
                const base64Data = base64Image.split(',')[1];
                const res = await fetch(GEMINI_URL, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [ { text: "–ß—Ç–æ –≤ —Ä—É–∫–µ? 1 word answer in English caps (SMOKE/EAT/OBJECT/EMPTY)." }, { inlineData: { mimeType: "image/jpeg", data: base64Data } } ] }] })
                });
                if (!res.ok) throw new Error("API Limit");
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text.trim();
                if (text.includes("SMOKE")) {
                    state.cigaretteCount++; addHistoryEvent('üö≠', '–ö—É—Ä–µ–Ω–∏–µ');
                    const msg = `–ü–æ–ª–æ–∂–∏ —Å–∏–≥–∞—Ä–µ—Ç—É! (–ó–∞–º–µ—á–µ–Ω–æ: ${state.cigaretteCount})`;
                    addChat(`üö≠ AI: ${msg}`, 'ai'); window.speakZen(msg, true); showAlert("–ù–µ –∫—É—Ä–∏! üö≠", "bg-red-600"); performSnapshot("smoke");
                } else if (text.includes("EAT")) {
                    state.foodCount++; addHistoryEvent('üçè', '–ï–¥–∞');
                    const msg = `–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞.`;
                    addChat(`üçè AI: ${msg}`, 'ai'); window.speakZen(msg, true); showAlert("–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∞–ø–ø–µ—Ç–∏—Ç–∞ üçè", "bg-green-600"); performSnapshot("eat");
                }
                updateStatsUI();
            } catch (e) { logDiag("AI Analysis Error"); }
            finally { state.isAnalyzing = false; document.getElementById('ai-analyzing-overlay').classList.add('hidden'); }
        }
        async function initAI() {
            try {
                logDiag("–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...");
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                drawingUtils = new DrawingUtils(ctx);
                faceLM = await FaceLandmarker.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "CPU" }, runningMode: "VIDEO", numFaces: 1, outputFaceBlendshapes: true });
                document.getElementById('ind-face').className = "status-dot dot-online"; document.getElementById('diag-face').innerText = "OK";
                handLM = await HandLandmarker.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "CPU" }, runningMode: "VIDEO", numHands: 2 });
                document.getElementById('ind-hand').className = "status-dot dot-online"; document.getElementById('diag-hand').innerText = "OK";
                objectDet = await ObjectDetector.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/object_detector/efficientdet_lite0/float16/1/efficientdet_lite0.tflite", delegate: "CPU" }, runningMode: "VIDEO", scoreThreshold: 0.35 });
                document.getElementById('ind-obj').className = "status-dot dot-online"; document.getElementById('diag-obj').innerText = "OK";
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').classList.remove('opacity-50');
                document.getElementById('status-text').innerText = "–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É";
                document.getElementById('pre-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('pre-loader').classList.add('hidden'), 700);
            } catch (err) { logDiag("–ö—Ä–∏—Ç –æ—à–∏–±–∫–∞ Init: " + err.message); showAlert("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AI", "bg-rose-600"); }
        }
        function analyzeLighting() {
            if (state.frameCount % 60 !== 0 || !state.features.light) return;
            const sampleC = document.createElement('canvas'); sampleC.width = 50; sampleC.height = 50;
            sampleC.getContext('2d').drawImage(video, 0, 0, 50, 50);
            const data = sampleC.getContext('2d').getImageData(0, 0, 50, 50).data;
            let sum = 0; for (let i = 0; i < data.length; i += 4) sum += (data[i] + data[i + 1] + data[i + 2]) / 3;
            state.avgLight = Math.round(sum / (data.length / 4));
            const lightStat = document.getElementById('light-val');
            const modalLight = document.getElementById('modal-light-status');
            lightStat.innerText = state.avgLight;
            if (state.avgLight < 40) {
                lightStat.className = "text-rose-600 animate-pulse"; modalLight.innerText = "–¢–µ–º–Ω–æ üåë";
                if (Date.now() - state.lastLightWarn > 60000) { state.lastLightWarn = Date.now(); showAlert("–í–∫–ª—é—á–∏—Ç–µ —Å–≤–µ—Ç üí°", "bg-yellow-600"); }
            } else { lightStat.className = "text-emerald-600"; modalLight.innerText = "–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ ‚òÄÔ∏è"; }
        }
        function checkNeckStretch(landmarks) {
            if (!state.features.stretch) return;
            const leftEye = landmarks[33]; const rightEye = landmarks[263];
            const angle = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x) * (180 / Math.PI);
            state.currTilt = angle;
            const tiltBar = document.getElementById('tilt-bar');
            document.getElementById('tilt-text').innerText = Math.round(angle) + "¬∞";
            tiltBar.style.transform = `rotate(${angle}deg)`;
            if (Math.abs(angle) > 25) {
                if (Date.now() - state.lastStretchTs > 4000) {
                    state.lastStretchTs = Date.now(); state.stretches++;
                    updateStatsUI(); addHistoryEvent('üßò', '–†–∞–∑–º–∏–Ω–∫–∞ —à–µ–∏'); triggerSuccess("–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞!", "–®–µ—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∞.", "stretch");
                }
            }
        }
        function checkYawn(landmarks) {
            if (!state.features.yawn) return;
            const mouthOpen = getDistance(landmarks[13], landmarks[14]);
            const faceHeight = getDistance(landmarks[10], landmarks[152]);
            const ratio = mouthOpen / faceHeight;
            if (ratio > 0.12) {
                document.getElementById('yawn-status').innerText = "–ó–µ–≤–æ—Ç–∞...";
                if (Date.now() - state.lastYawnTs > 10000) {
                    state.lastYawnTs = Date.now(); showAlert("–í—ã —É—Å—Ç–∞–ª–∏?", "bg-indigo-600"); window.speakZen("–ö–∞–∂–µ—Ç—Å—è, –≤—ã —É—Å—Ç–∞–ª–∏.");
                }
            } else { document.getElementById('yawn-status').innerText = "–ë–æ–¥—Ä"; }
        }
        function checkFaceYoga(landmarks) {
            if (!state.features.faceYoga) return;
            const ratio = ((getDistance(landmarks[159], landmarks[65]) + getDistance(landmarks[386], landmarks[295])) / 2) / getDistance(landmarks[10], landmarks[152]);
            if (ratio > 0.08 && Date.now() - state.lastYogaTs > 5000) {
                state.lastYogaTs = Date.now(); state.faceYoga++; updateStatsUI(); addHistoryEvent('ü§®', '–§–µ–π—Å-–π–æ–≥–∞'); triggerSuccess("–û—Ç–ª–∏—á–Ω–∞—è –§–µ–π—Å-–ô–æ–≥–∞!", "–õ–æ–± —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω.", "yoga");
            }
        }
        function checkZenGesture(landmarksArray) {
            if (!state.features.zen || landmarksArray.length < 2) return;
            const h1 = landmarksArray[0], h2 = landmarksArray[1];
            if (getDistance(h1[0], h2[0]) < 0.1 && getDistance(h1[20], h2[20]) < 0.1) { if (!state.isZenMode) toggleZenMode(true); }
            else { if (state.isZenMode) toggleZenMode(false); }
        }
        function checkHeartGesture(landmarksArray) {
            if (!state.features.heart || landmarksArray.length < 2) return;
            const h1 = landmarksArray[0], h2 = landmarksArray[1];
            if (getDistance(h1[8], h2[8]) < 0.08 && getDistance(h1[4], h2[4]) < 0.08 && h1[4].y > h1[8].y) {
                if (Date.now() - state.lastGestureTs > 5000) { state.lastGestureTs = Date.now(); triggerSuccess("–õ—é–±–æ–≤—å –∫ —Å–µ–±–µ!", "–í—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã!", "heart"); }
            }
        }
        function toggleZenMode(active) {
            state.isZenMode = active;
            const status = document.getElementById('zen-status');
            if (active) { document.body.classList.add('zen-active'); status.innerText = "–ê–ö–¢–ò–í–ï–ù"; window.speakZen("–†–µ–∂–∏–º –î–∑–µ–Ω.", true); performSnapshot("zen"); }
            else { document.body.classList.remove('zen-active'); status.innerText = "–°–ª–æ–∂–∏ —Ä—É–∫–∏"; window.speechSynthesis.cancel(); }
        }
        function checkBlinks(landmarks) {
            if (!state.features.blink) return;
            const ear = (getDistance(landmarks[158], landmarks[153]) + getDistance(landmarks[160], landmarks[144])) / (getDistance(landmarks[33], landmarks[133]) * 2);
            if (ear < 0.15) {
                const now = Date.now();
                if (state.blinkHistory.length === 0 || now - state.blinkHistory[state.blinkHistory.length - 1] > 200) { state.blinkHistory.push(now); state.blinks++; }
            }
            state.blinkHistory = state.blinkHistory.filter(t => t > Date.now() - 60000);
        }
        function checkSmile(landmarks) {
            if (!state.features.smile) return;
            const ratio = getDistance(landmarks[61], landmarks[291]) / getDistance(landmarks[234], landmarks[454]);
            if (ratio > 0.38 && Date.now() - state.lastActionTs > 2000) {
                state.lastActionTs = Date.now(); state.smiles++; updateStatsUI(); addHistoryEvent('üòä', '–£–ª—ã–±–∫–∞'); triggerSuccess("–£–ª—ã–±–∫–∞!", "–†–∞–¥–æ—Å—Ç—å.", "smile");
            }
        }
        function checkPos(landmarks) {
            const eyeDist = getDistance(landmarks[33], landmarks[263]);
            state.currDist = eyeDist;
            const distBar = document.getElementById('dist-bar'); const distText = document.getElementById('dist-text');
            let pct = (eyeDist - 0.05) / 0.25 * 100; distBar.style.width = Math.max(5, Math.min(100, pct)) + "%";
            if (state.features.distance) {
                if (eyeDist > 0.25) {
                    distText.innerText = "–ë–ª–∏–∑–∫–æ!"; if (Date.now() - state.lastDistanceWarn > 15000) { state.lastDistanceWarn = Date.now(); showAlert("–û—Ç–æ–¥–≤–∏–Ω—å—Ç–µ—Å—å", "bg-rose-600"); }
                } else if (eyeDist < 0.10) {
                    distText.innerText = "–î–∞–ª–µ–∫–æ!"; if (Date.now() - state.lastDistanceWarn > 15000) { state.lastDistanceWarn = Date.now(); showAlert("–ë–ª–∏–∂–µ", "bg-amber-500"); }
                } else { distText.innerText = "–ù–æ—Ä–º–∞"; }
            }
        }
        function triggerSuccess(msg, voiceMsg, type = "water") {
            const overlay = document.getElementById('touch-overlay');
            document.getElementById('overlay-msg').innerText = type === "smile" ? "–°—á–∞—Å—Ç—å–µ!" : type === "stretch" ? "–†–∞–∑–º–∏–Ω–∫–∞!" : "–ü–æ–ª—å–∑–∞!";
            overlay.classList.add('active'); setTimeout(() => overlay.classList.remove('active'), 1500);
            if (type === "water") {
                state.water++; updateWaterVisuals(); addHistoryEvent('üíß', '–í—ã–ø–∏—Ç–∞ –≤–æ–¥–∞');
                if (state.water % 3 === 0 && state.treeLevel < TREES.length) { state.treeLevel++; document.getElementById('tree-lvl').innerText = state.treeLevel; document.getElementById('tree-display').innerText = TREES[state.treeLevel - 1]; }
            }
            updateStatsUI(); performSnapshot(type); addChat(msg, 'ai'); window.speakZen(voiceMsg || msg);
        }
        function checkVibe(blendshapes) {
            if (!blendshapes || blendshapes.length === 0) return;
            const bs = blendshapes[0].categories;
            const getScore = (name) => bs.find(c => c.categoryName === name)?.score || 0;
            let emoji = "üòê";
            if ((getScore('mouthSmileLeft') + getScore('mouthSmileRight')) > 0.5) emoji = "üòÑ";
            else if ((getScore('browOuterUpLeft') + getScore('browOuterUpRight')) > 0.5) emoji = "üòÆ";
            else if (getScore('mouthPucker') > 0.5) emoji = "üòó";
            document.getElementById('vibe-emoji').innerText = emoji; document.getElementById('vr-vibe').innerText = emoji;
        }
        async function predict() {
            if (!state.cameraActive) return;
            const now = performance.now();
            if (now - lastTime < (state.lowPowerMode ? 66 : 33)) { requestAnimationFrame(predict); return; }
            const fps = Math.round(1000 / (now - lastTime)); lastTime = now;
            if (fps < 15) { state.lowFPSCount++; if (state.lowFPSCount > 50 && !state.lowPowerMode) { state.lowPowerMode = true; state.features.worldLens = false; showAlert("–†–µ–∂–∏–º —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è üîã", "bg-yellow-600"); } }
            document.getElementById('diag-fps').innerText = fps;
            const ts = now;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            analyzeLighting();
            let mouthPos = null;
            let faceLandmarks = null;
            if (faceLM) {
                const res = faceLM.detectForVideo(video, ts);
                if (state.features.privacy) document.body.classList.toggle('privacy-blur', res.faceLandmarks.length > 1);
                if (res?.faceLandmarks?.[0]) {
                    const lm = res.faceLandmarks[0];
                    faceLandmarks = lm;
                    mouthPos = { x: (lm[13].x + lm[14].x) / 2, y: (lm[13].y + lm[14].y) / 2 };
                    state.lastMouthPos = mouthPos; state.lastMouthTs = Date.now(); state.lastFaceSeenTs = Date.now();
                    drawingUtils.drawConnectors(lm, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "#ffffff20", lineWidth: 0.5 });
                    checkBlinks(lm); checkSmile(lm); checkPos(lm); checkNeckStretch(lm); checkYawn(lm); checkFaceYoga(lm); checkVibe(res.faceBlendshapes);
                    const nose = lm[1];
                    const pBar = document.getElementById('posture-bar');
                    const pText = document.getElementById('posture-text');
                    if (state.features.posture) {
                        if (nose.y > 0.70) {
                            state.currPosture = "bad"; pBar.style.width = "40%"; pBar.className = "progress-bar-fill bg-rose-500";
                            if (pText) { pText.innerText = "–ü–ª–æ—Ö–æ"; pText.className = "text-rose-600"; }
                            if (state.frameCount % 60 === 0) { state.postureCorrections++; updateStatsUI(); }
                            if (Date.now() - state.lastPostureWarn > 15000) { state.lastPostureWarn = Date.now(); window.speakZen("–í—ã–ø—Ä—è–º–∏—Ç–µ —Å–ø–∏–Ω—É."); addHistoryEvent('üö∂', '–°–±–æ–π –æ—Å–∞–Ω–∫–∏'); }
                        } else { state.currPosture = "ok"; pBar.style.width = "100%"; pBar.className = "progress-bar-fill bg-emerald-500";
                            if (pText) { pText.innerText = "–•–æ—Ä–æ—à–æ"; pText.className = "text-emerald-600"; }
                        }
                    }
                    // --- Sport Mode Logic Integration ---
                    if (state.features.sportMode) {
                        // 1. Calibration (First 5 seconds - collect baseline nose Y values)
                        if (state.frameCount < 150 && state.baselineNoseY === null) {
                            // Collecting baseline samples during first 150 frames
                            state.calibrationSamples.push(nose.y);
                        } else if (state.frameCount === 150 && state.calibrationSamples.length > 0) {
                            // Average the collected samples for a stable baseline
                            const avg = state.calibrationSamples.reduce((a, b) => a + b, 0) / state.calibrationSamples.length;
                            state.baselineNoseY = avg;
                            state.calibrationSamples = []; // Clear samples
                        }
                        // 2. Detection (Standing Up)
                        // If nose is significantly higher (y is smaller) OR face is missing (user walked away)
                        // Guard: skip if calibration not complete
                        const isStanding = state.baselineNoseY !== null && (nose.y < (state.baselineNoseY - 0.15));
                        if (isStanding && !state.isExercising) {
                            if (Date.now() - state.lastStandUpCheck > 2000) { // Debounce
                                state.isExercising = true;
                                state.exerciseStartTime = Date.now();
                                document.getElementById('sport-overlay').classList.add('active');
                                window.speakZen("–†–µ–∂–∏–º —Å–ø–æ—Ä—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í—Ä–µ–º—è –ø–æ—à–ª–æ.");
                            }
                        }
                        // 3. Detection (Sitting Down)
                        else if (!isStanding && state.isExercising) {
                            // Debounce sitting down to avoid flicker
                            if (Date.now() - state.lastStandUpCheck > 3000) {
                                state.isExercising = false;
                                document.getElementById('sport-overlay').classList.remove('active');
                                const seconds = Math.floor((Date.now() - state.exerciseStartTime) / 1000);
                                if (seconds > 5) { // Only reward if meaningful exercise
                                    const msg = `–ú–æ–ª–æ–¥–µ—Ü! –í—ã –∑–∞–Ω–∏–º–∞–ª–∏—Å—å —Å–ø–æ—Ä—Ç–æ–º ${seconds} —Å–µ–∫—É–Ω–¥.`;
                                    window.speakZen(msg);
                                    triggerSuccess("–°–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!", msg, "energy");
                                    // Show Medal (Simulated by Success Trigger for now)
                                    const medal = document.createElement('div');
                                    medal.innerHTML = "ü•á";
                                    medal.className = "fixed inset-0 flex items-center justify-center text-9xl z-50 pointer-events-none medal-pop";
                                    document.body.appendChild(medal);
                                    setTimeout(() => medal.remove(), 2000);
                                    state.sittingStartTime = Date.now(); // Reset sedentary timer
                                }
                            }
                        } else {
                            state.lastStandUpCheck = Date.now();
                        }
                    }
                }
            }
            let handLandmarks = [];
            if (handLM && state.frameCount % 2 === 0) {
                const res = handLM.detectForVideo(video, ts);
                if (res?.landmarks) {
                    handLandmarks = res.landmarks;
                    checkZenGesture(res.landmarks); checkHeartGesture(res.landmarks);
                    // Fix: Check for face touch detection
                    if (state.features.faceTouch && faceLandmarks) {
                        const nose = faceLandmarks[1];
                        const forehead = faceLandmarks[10];
                        const leftCheek = faceLandmarks[234];
                        const rightCheek = faceLandmarks[454];
                        res.landmarks.forEach(h => {
                            const handTip = h[8]; // Middle finger tip
                            // Check if hand is near face landmarks (forehead/cheeks)
                            if (handTip && (
                                Math.sqrt(Math.pow(handTip.x - forehead.x, 2) + Math.pow(handTip.y - forehead.y, 2)) < 0.1 ||
                                Math.sqrt(Math.pow(handTip.x - leftCheek.x, 2) + Math.pow(handTip.y - leftCheek.y, 2)) < 0.1 ||
                                Math.sqrt(Math.pow(handTip.x - rightCheek.x, 2) + Math.pow(handTip.y - rightCheek.y, 2)) < 0.1
                            )) {
                                if (Date.now() - state.lastFaceTouchWarn > 10000) {
                                    state.lastFaceTouchWarn = Date.now();
                                    window.speakZen("–ù–µ —Ç—Ä–æ–≥–∞–π –ª–∏—Ü–æ.");
                                    addHistoryEvent('‚úã', '–†—É–∫–∞ –≤–æ–∑–ª–µ –ª–∏—Ü–∞');
                                    showAlert("–ù–µ —Ç—Ä–æ–≥–∞–π—Ç–µ –ª–∏—Ü–æ!", "bg-yellow-600");
                                }
                            }
                        });
                    }
                    res.landmarks.forEach(h => {
                        drawingUtils.drawConnectors(h, HandLandmarker.HAND_CONNECTIONS, { color: "#34d399", lineWidth: 2 });
                        if (mouthPos && !state.isZenMode) {
                            const pX = (h[8].x + h[4].x) / 2, pY = (h[8].y + h[4].y) / 2;
                            if (Math.sqrt(Math.pow(pX - mouthPos.x, 2) + Math.pow(pY - mouthPos.y, 2)) < 0.12) {
                                if (state.features.aiObjectCheck && !state.isAnalyzing && Date.now() - state.lastAiCheck > 15000) {
                                    state.lastAiCheck = Date.now();
                                    const snap = performSnapshot("ai-check");
                                    if (snap) analyzeObjectWithGemini(snap);
                                }
                                document.getElementById('dbg-status').innerText = "–ü–¨–ï–¢?";
                                if (Date.now() - state.lastActionTs > 5000 && state.features.water) {
                                    // Basic water trigger if hands near mouth (simplified)
                                    state.lastActionTs = Date.now(); triggerSuccess("–í–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å.", "–í—ã–ø–µ–π –≤–æ–¥—ã.", "water");
                                }
                            }
                        }
                    });
                }
            }
            if (objectDet && !state.isZenMode) {
                if (state.frameCount % (state.lowPowerMode ? 10 : 5) === 0) {
                    const res = objectDet.detectForVideo(video, ts);
                    if (res.detections) state.lastDetections = res.detections;
                }
                state.lastDetections.forEach(det => {
                    const name = det.categories[0].categoryName.toLowerCase();
                    const b = det.boundingBox;
                    if (state.features.worldLens && !["bottle", "cup", "cell phone"].includes(name)) {
                        ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 1; ctx.strokeRect(b.originX, b.originY, b.width, b.height);
                        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(b.originX, b.originY - 15, ctx.measureText(OBJECT_TRANSLATIONS[name] || name).width + 10, 15);
                        ctx.fillStyle = "white"; ctx.fillText(OBJECT_TRANSLATIONS[name] || name, b.originX + 5, b.originY - 4);
                    }
                    if (["bottle", "cup", "mug"].includes(name)) {
                        ctx.strokeStyle = "#34d399"; ctx.lineWidth = 2; ctx.strokeRect(b.originX, b.originY, b.width, b.height);
                        document.getElementById('dbg-obj').innerText = "–í–û–î–ê";
                    }
                    if (state.features.phone && name === "cell phone") {
                        ctx.strokeStyle = "red"; ctx.lineWidth = 4; ctx.strokeRect(b.originX, b.originY, b.width, b.height);
                        if (Date.now() - state.lastPhoneWarn > 20000) { state.lastPhoneWarn = Date.now(); showAlert("–£–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω üìµ", "bg-rose-600"); window.speakZen("–£–±–µ—Ä–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω."); }
                    }
                });
            }
            state.frameCount++; requestAnimationFrame(predict);
        }
        function addChat(text, role) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = `chat-bubble ${role === 'user' ? 'chat-user' : 'chat-ai'} animate-fade-in`;
            d.innerHTML = text;
            box.appendChild(d); box.scrollTop = box.scrollHeight;
        }
        document.getElementById('startBtn').onclick = async () => {
            unlockAudio(); checkTimeTheme();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    video.play(); state.cameraActive = true; state.focusStartTime = Date.now(); state.lastFocusUpdate = Date.now();
                    document.getElementById('startBtn').classList.add('hidden'); document.getElementById('live-ui').classList.remove('hidden');
                    document.getElementById('diag-cam').innerText = "OK"; document.getElementById('diag-cam').className = "text-green-600 font-bold";
                    predict(); window.speakZen("–°–∏—Å—Ç–µ–º—ã –∞–∫—Ç–∏–≤–Ω—ã.", true);
                };
            } catch (e) { showAlert("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã.", "bg-rose-600"); }
        };
        document.getElementById('adviceBtn').onclick = async () => {
            unlockAudio();
            const btn = document.getElementById('adviceBtn'); btn.disabled = true; btn.innerText = "–°–≤—è–∑—å...";
            addChat("–ù—É–∂–µ–Ω —Å–æ–≤–µ—Ç...", 'user');
            try {
                // Fix: Check if API key is empty
                if (!apiKey || apiKey.trim() === '') {
                    addChat("AI –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ Gemini API –∫–ª—é—á –≤ –∫–æ–¥–µ.", 'ai');
                    throw new Error("API key not configured");
                }
                const res = await fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "–î–∞–π –¥–∑–µ–Ω —Å–æ–≤–µ—Ç (–º–∞–∫—Å 10 —Å–ª–æ–≤)." }] }] }) });
                const data = await res.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                addChat(aiResponse, 'ai'); window.speakZen(aiResponse);
            } catch (e) { addChat("–î—ã—à–∏ –≥–ª—É–±–∂–µ.", 'ai'); window.speakZen("–î—ã—à–∏ –≥–ª—É–±–∂–µ."); }
            btn.disabled = false; btn.innerText = "‚ú® –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ú—É–¥—Ä–æ—Å—Ç—å";
        };
        initAI();
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(reg => {
                        console.log('[ZenFlow] Service Worker registered:', reg.scope);
                        
                        // Check for updates periodically
                        setInterval(() => reg.update(), 60 * 60 * 1000);
                        
                        // Listen for SW messages
                        navigator.serviceWorker.addEventListener('message', event => {
                            if (event.data?.type === 'WELLNESS_CHECK') {
                                console.log('[ZenFlow] Wellness check from SW');
                            }
                        });
                    })
                    .catch(err => console.warn('[ZenFlow] SW registration failed:', err));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button in nav
            const installBtn = document.createElement('button');
            installBtn.className = 'p-2 rounded-full bg-emerald-50 hover:bg-emerald-100 transition-all text-emerald-700 border border-emerald-100 animate-pulse';
            installBtn.title = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ZenFlow';
            installBtn.innerHTML = 'üì≤';
            installBtn.onclick = async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBtn.remove();
                }
                deferredPrompt = null;
            };
            
            // Insert before the audio button in nav
            const audioBtn = document.getElementById('audioUnlockBtn');
            if (audioBtn?.parentNode) {
                audioBtn.parentNode.insertBefore(installBtn, audioBtn);
            }
        });

        // Handle app installed event
        window.addEventListener('appinstalled', () => {
            console.log('[ZenFlow] App installed successfully');
            deferredPrompt = null;
        });

        // Detect if running as installed PWA
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            document.body.classList.add('pwa-standalone');
            console.log('[ZenFlow] Running as installed PWA');
        }
    </script>
</body>
</html>
